name: benchmarks

on:
  workflow_dispatch:

jobs:
  deploy-runner:
    runs-on: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v3

      - uses: iterative/setup-cml@v1

      - name: deploy
        env:
          repo_token: ${{ secrets.HAYSTACK_BOT_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_CI_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_CI_SECRET_ACCESS_KEY }}
          AWS_CML_SECURITY_GROUP: ${{ secrets.AWS_CML_SECURITY_GROUP }}
        run: |
          cml runner launch \
          --cloud aws \
          --cloud-region us-east-1 \
          --cloud-type=p3.2xlarge \
          --cloud-aws-security-group="$AWS_CML_SECURITY_GROUP" \
          --labels=cml-runner

  run-benchmark:
    needs: deploy-runner
    runs-on: [self-hosted, cml-runner]
    container:
      image: docker://iterativeai/cml:0-dvc2-base1-gpu
      options: --gpus all
    steps:
      - uses: actions/checkout@v3

      - name: Install Haystack
        run: pip install ".[all]"

      - name: Run benchmarks
        run: |
          python ./test/benchmarks/run.py \
          --retriever-configs ./test/benchmarks/configs/retriever/ \
          --reader-configs ./test/benchmarks/configs/reader/ \
          --result-file report.json

      - uses: actions/upload-artifact@v3
        with:
          name: benchmark-report.json
          path: report.json
